<li class="item-card"
    data-title="<%= (item.title || '').toLowerCase() %>"
    data-description="<%= (item.description || '').toLowerCase() %>"
    data-price="<%= item.price || 0 %>"
    data-condition="<%= (item.condition || '').toLowerCase() %>"
    data-platform="<%= (item.platform || '').toLowerCase() %>"
    data-available="<%= item.available ? 'true' : 'false' %>">
    <div class="card-grid">
      
      <!-- Left Side: Thumbnail -->
      <div class="item-thumb">
        <% if (item.imageLinks && item.imageLinks[0]) { %>
          <img src="<%= item.imageLinks[0] %>" alt="Item Image">
        <% } else { %>
          <div class="no-img">No Image</div>
        <% } %>
      </div>
  
      <!-- Center: Info -->
      <div class="item-info">
        <p class="title">
          <a href="<%= item.link %>" target="_blank" rel="noopener noreferrer">
            <%= item.title %> ðŸ”—
          </a>
        </p>
        <p><strong>Price:</strong> <%= item.price || 'N/A' %></p>
        <p><strong>Condition:</strong> <%= item.condition || 'N/A' %></p>
        <p><strong>Description:</strong> <%= item.description || 'N/A' %></p>
        <p><strong>Location:</strong> <%= item.location || 'N/A' %></p>
        <p><strong>Platform:</strong> <%= item.platform || 'N/A' %></p>
        <p><strong>Available:</strong> <%= item.available ? 'Yes' : 'No' %></p>
  
        <% if (showCategories && categories) { %>
          <p><strong>Currently in:</strong>
            <% categories.forEach(cat => { 
                const match = cat.items.some(i => {
                  const iId = i.item ? i.item._id : i._id;
                  return iId.toString() === item._id.toString();
                });
                if (cat.name !== 'All Listings' && match) { %>
              <span class="category-label"><%= cat.name %></span>
            <% }}) %>
          </p>
        <% } %>
  
        <% if (showAddedBy && addedBy && addedBy.username) { %>
          <p class="added-by-badge">
            added by <%= user && addedBy._id.toString() === user._id.toString() ? "You" : addedBy.username %>
          </p>
        <% } %>
      </div>
  
      <!-- Right Side: Actions -->
      <div class="item-actions">
        <% if (allowEdit && categories) { %>
          <%
            const catCount = categories.filter(c =>
              c.name !== 'All Listings' &&
              c.items.some(i => {
                const iId = i.item ? i.item._id : i._id;
                return iId.toString() === item._id.toString();
              })
            ).length;
          %>
          <div class="category-picker">
            <button type="button" class="picker-toggle" data-item-id="<%= item._id %>">
              Categories (<span class="cat-count"><%= catCount %></span>)
            </button>
            <div class="picker-dropdown" style="display:none;">
              <form class="category-checkbox-form" data-item-id="<%= item._id %>">
                <% categories.forEach(cat => {
                    if (cat.name !== 'All Listings') {
                      const isChecked = cat.items.some(i => {
                        const iId = i.item ? i.item._id : i._id;
                        return iId.toString() === item._id.toString();
                      });
                %>
                  <label class="checkbox-item">
                    <input type="checkbox" name="categories" value="<%= cat._id %>" <%= isChecked ? 'checked' : '' %>>
                    <span><%= cat.name %></span>
                  </label>
                <% }}) %>
                <button type="submit" class="save-btn">Save</button>
              </form>
            </div>
          </div>
        <% } %>
  
        <% if (categoryId && user && (isOwner || (addedBy && addedBy._id.toString() === user._id.toString()))) { %>
          <form method="POST" action="/categories/<%= categoryId %>/remove-item" style="margin-top: 10px;">
            <input type="hidden" name="itemId" value="<%= item._id %>">
            <button type="submit" onclick="return confirm('Remove this listing from this category?')">
              Remove from Category
            </button>
          </form>
        <% } else if (!categoryId && allowDelete && isOwner) { %>
          <form method="POST" action="/items/<%= item._id %>?_method=DELETE" style="margin-top: 10px;">
            <button type="submit" onclick="return confirm('Are you sure you want to delete this listing?')">
              Delete Listing
            </button>
          </form>
        <% } %>
      </div>
    </div>
  </li>
  