<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

  <%- include('partials/navbar') %>

  <main class="container">

    <!-- Welcome Row -->
    <div class="dashboard-welcome">
      <h1>Welcome, <%= user.username %></h1>
      <button id="openAddModal" class="btn-primary">+ Add Listing</button>
    </div>

    <!-- Add Listing Modal -->
    <div id="addListingModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Add New Listing</h2>
          <button type="button" class="modal-close">&times;</button>
        </div>

        <div class="modal-body">
          <!-- Step 1: URL Input -->
          <div id="step1" class="modal-step">
            <form id="previewForm">
              <label for="link">Paste OfferUp URL:</label>
              <input type="url" name="link" id="link" placeholder="https://offerup.com/item/..." required>
              <button type="submit" class="btn-primary">Preview</button>
            </form>
            <div id="previewError" class="error-msg" style="display:none;"></div>
          </div>

          <!-- Step 2: Preview & Confirm -->
          <div id="step2" class="modal-step" style="display:none;">
            <div class="preview-card">
              <img id="previewImage" src="" alt="Item">
              <div class="preview-info">
                <h3 id="previewTitle"></h3>
                <p class="price" id="previewPrice"></p>
                <p><strong>Condition:</strong> <span id="previewCondition"></span></p>
                <p><strong>Location:</strong> <span id="previewLocation"></span></p>
                <p class="description" id="previewDesc"></p>
              </div>
            </div>

            <form id="finalAddForm" method="POST" action="/items/add">
              <input type="hidden" name="link" id="finalLink">
              <input type="hidden" name="defaultCategoryId" value="<%= categories.find(c => c.name === 'All Listings')._id %>">
              <input type="hidden" name="cachedTitle" id="cachedTitle">
              <input type="hidden" name="cachedPrice" id="cachedPrice">
              <input type="hidden" name="cachedCondition" id="cachedCondition">
              <input type="hidden" name="cachedDescription" id="cachedDescription">
              <input type="hidden" name="cachedLocation" id="cachedLocation">
              <input type="hidden" name="cachedImageLinks" id="cachedImageLinks">
              <input type="hidden" name="cachedAvailable" id="cachedAvailable">

              <% if (categories.length > 1) { %>
                <label for="category">Add to category:</label>
                <select name="category">
                  <option value="">None (All Listings only)</option>
                  <% categories.forEach(category => { %>
                    <% if (category.name !== 'All Listings') { %>
                      <option value="<%= category._id %>"><%= category.name %></option>
                    <% } %>
                  <% }) %>
                </select>
              <% } %>

              <div class="modal-actions">
                <button type="button" id="backToStep1" class="btn-secondary">Back</button>
                <button type="submit" class="btn-primary">Add Listing</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat">
        <span class="stat-value"><%= stats.totalItems %></span>
        <span class="stat-label">listings</span>
      </div>
      <div class="stat">
        <span class="stat-value">$<%= stats.totalValue.toFixed(2) %></span>
        <span class="stat-label">total value</span>
      </div>
      <div class="stat">
        <span class="stat-value"><%= stats.availableCount %></span>
        <span class="stat-label">available</span>
      </div>
      <div class="stat">
        <span class="stat-value"><%= stats.categoryCount %></span>
        <span class="stat-label">categories</span>
      </div>
    </div>

    <!-- ===================== -->
    <!-- Section: Recent Listings -->
    <!-- ===================== -->
    <section class="dashboard-section">
      <div class="dashboard-header">
        <h2>Recent Listings</h2>
        <a href="/listings">View All</a>
      </div>

      <% const allListings = categories.find(c => c.name === 'All Listings'); %>
      <% if (!allListings || allListings.items.length === 0) { %>
        <div class="empty-state">
          <p>No listings yet.</p>
          <p class="muted">Click "+ Add Listing" above to save your first item.</p>
        </div>
      <% } else { %>
        <%- include('partials/item-list', {
          items: allListings.items,
          categories,
          maxItems: 3,
          allowEdit: true,
          allowDelete: true,
          showCategories: true,
          user: user,
          isOwner: true
        }) %>
      <% } %>
    </section>

    <!-- ===================== -->
    <!-- Section: My Categories -->
    <!-- ===================== -->
    <section class="dashboard-section">
      <div class="dashboard-header">
        <h2>My Categories</h2>
        <a href="/categories">View All</a>
      </div>

      <% const userCategories = categories.filter(c => c.name !== 'All Listings'); %>

      <div class="category-grid">
        <% userCategories.slice(0, 5).forEach(category => { %>
          <div class="category-card">
            <a href="/categories/<%= category._id %>" class="category-card-link">
              <h3 class="category-name"><%= category.name %></h3>
              <p class="category-meta"><%= category.items.length %> item<%= category.items.length !== 1 ? 's' : '' %></p>
            </a>
          </div>
        <% }) %>

        <!-- Create New Category Card -->
        <div class="category-card create-card">
          <form action="/categories/create" method="POST" class="create-card-form">
            <input type="text" name="name" placeholder="Category name" required>
            <button type="submit" class="btn-primary">+ Create</button>
          </form>
        </div>
      </div>
    </section>

    <!-- ===================== -->
    <!-- Section: Shared With Me -->
    <!-- ===================== -->
    <% if (sharedCategories && sharedCategories.length > 0) { %>
      <section class="dashboard-section">
        <div class="dashboard-header">
          <h2>Shared With Me</h2>
        </div>

        <div class="category-grid">
          <% sharedCategories.forEach(category => { %>
            <div class="category-card category-card--shared">
              <a href="/categories/<%= category._id %>" class="category-card-link">
                <span class="shared-badge">Shared</span>
                <h3 class="category-name"><%= category.name %></h3>
                <p class="category-meta"><%= category.items.length %> item<%= category.items.length !== 1 ? 's' : '' %></p>
              </a>
            </div>
          <% }) %>
        </div>
      </section>
    <% } %>

  </main>

  <script src="/js/dashboard.js"></script>
  <script src="/js/assign-categories.js"></script>

</body>
</html>
