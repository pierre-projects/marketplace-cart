<!DOCTYPE html>
<html>
<head>
  <title><%= category.name %></title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('../partials/navbar') %>

  <main class="container">

    <!-- Page Header -->
    <div class="show-header">
      <div class="show-header-left">
        <a href="/categories" class="back-link">&larr; Categories</a>
        <h1><%= category.name %></h1>
      </div>
      <% if (isOwner) { %>
        <button type="button" id="openSettingsModal" class="manage-btn">Settings</button>
      <% } %>
    </div>

    <!-- Stats Bar -->
    <% const itemCount = category.items.length; %>
    <% let totalValue = 0; let availCount = 0; %>
    <% category.items.forEach(entry => {
      const it = entry.item || entry;
      const p = typeof it.price === 'number' ? it.price : parseFloat(it.price) || 0;
      totalValue += p;
      if (it.available) availCount++;
    }); %>

    <% if (itemCount > 0) { %>
      <div class="stats-bar">
        <div class="stat">
          <span class="stat-value"><%= itemCount %></span>
          <span class="stat-label">items</span>
        </div>
        <div class="stat">
          <span class="stat-value">$<%= totalValue.toFixed(2) %></span>
          <span class="stat-label">total value</span>
        </div>
        <div class="stat">
          <span class="stat-value"><%= availCount %></span>
          <span class="stat-label">available</span>
        </div>
      </div>
    <% } %>

    <!-- Shared Info (non-owner viewers) -->
    <% if (!isOwner && user) { %>
      <div class="shared-notice">
        Shared with you
        <% if (canEdit) { %> &middot; You can edit<% } %>
      </div>
    <% } %>

    <!-- Public badge -->
    <% if (category.isPublic && !isOwner) { %>
      <div class="shared-notice">Public category</div>
    <% } %>

    <!-- Add Item (editor/owner) -->
    <% if (canEdit) { %>
      <div class="add-item-bar">
        <form action="/categories/<%= category._id %>/add-item" method="POST" class="add-item-form">
          <input type="url" name="link" placeholder="Paste an item link to add..." required>
          <button type="submit" class="btn-primary">+ Add</button>
        </form>
      </div>
    <% } %>

    <!-- Items -->
    <% if (category.items.length === 0) { %>
      <div class="empty-state">
        <p>No items in this category yet.</p>
        <% if (canEdit) { %>
          <p class="muted">Add one using the form above.</p>
        <% } %>
      </div>
    <% } else { %>
      <%- include('../partials/item-list', {
        items: category.items,
        categories,
        allowEdit: canEdit,
        allowDelete: canEdit,
        showCategories: false,
        categoryId: category._id,
        user: user,
        isOwner: isOwner,
        showAddedBy: true
      }) %>
    <% } %>

  </main>

  <!-- Settings Modal (owner only) -->
  <% if (isOwner) { %>
    <div id="settingsModal" class="modal-overlay" style="display:none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Category Settings</h2>
          <button type="button" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">

          <!-- Visibility -->
          <div class="settings-section">
            <h4 class="settings-label">Visibility</h4>
            <form action="/categories/<%= category._id %>/visibility" method="POST">
              <label class="toggle-row">
                <input type="checkbox" name="isPublic" value="true" onchange="this.form.submit()" <%= category.isPublic ? 'checked' : '' %>>
                <span>Make this category public</span>
              </label>
            </form>
          </div>

          <hr class="modal-divider">

          <!-- Share -->
          <div class="settings-section">
            <h4 class="settings-label">Share</h4>
            <form action="/categories/<%= category._id %>/share" method="POST" class="share-form">
              <input type="email" name="email" placeholder="User email" required>
              <select name="access">
                <option value="viewer">Viewer</option>
                <option value="editor">Editor</option>
              </select>
              <button type="submit" class="btn-primary">Share</button>
            </form>
          </div>

          <!-- Shared Users -->
          <% if (category.usersAdded && category.usersAdded.length > 0) { %>
            <hr class="modal-divider">
            <div class="settings-section">
              <h4 class="settings-label">Shared With</h4>
              <ul class="shared-users-list">
                <% category.usersAdded.forEach(entry => { %>
                  <li class="shared-user-row">
                    <span class="shared-user-name"><%= entry.user.username %></span>
                    <form action="/categories/<%= category._id %>/update-role" method="POST" class="role-form">
                      <input type="hidden" name="userId" value="<%= entry.user._id %>">
                      <select name="newRole" onchange="this.form.submit()">
                        <option value="viewer" <%= entry.role === 'viewer' ? 'selected' : '' %>>Viewer</option>
                        <option value="editor" <%= entry.role === 'editor' ? 'selected' : '' %>>Editor</option>
                      </select>
                    </form>
                    <form action="/categories/<%= category._id %>/remove-user" method="POST">
                      <input type="hidden" name="userId" value="<%= entry.user._id %>">
                      <button type="submit" class="remove-user-btn" onclick="return confirm('Remove access for this user?')">&times;</button>
                    </form>
                  </li>
                <% }) %>
              </ul>
            </div>
          <% } %>

        </div>
      </div>
    </div>
  <% } %>

  <script src="/js/assign-categories.js"></script>
  <script>
    const itemData = <%- JSON.stringify(category.items) %>;
  </script>
  <script src="/js/totals.js"></script>
  <% if (isOwner) { %>
    <script src="/js/category-show.js"></script>
  <% } %>

</body>
</html>
